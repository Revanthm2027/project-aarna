/* /admin/admin.js */
(function () {
  const ADMIN_EMAIL = "projectaarna@protonmail.com";

  // Candidate table names (in case yours differ)
  const TABLE_CANDIDATES = {
    experiments: ["experiments"],
    messages: ["contact_messages", "messages", "contact"],
    newsletter: ["newsletter_subscribers", "newsletter", "subscribers"],
  };

  const root = document.getElementById("admin-root");
  if (!root) return;

  // ---------- tiny UI helpers ----------
  function esc(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function toast(msg, type = "info") {
    let wrap = document.getElementById("admin-toasts");
    if (!wrap) {
      wrap = document.createElement("div");
      wrap.id = "admin-toasts";
      wrap.style.position = "fixed";
      wrap.style.right = "16px";
      wrap.style.bottom = "16px";
      wrap.style.zIndex = "9999";
      wrap.style.display = "flex";
      wrap.style.flexDirection = "column";
      wrap.style.gap = "10px";
      document.body.appendChild(wrap);
    }

    const t = document.createElement("div");
    t.style.padding = "12px 14px";
    t.style.borderRadius = "12px";
    t.style.border = "1px solid rgba(255,255,255,0.18)";
    t.style.background = "rgba(10, 18, 40, 0.92)";
    t.style.backdropFilter = "blur(10px)";
    t.style.color = "white";
    t.style.maxWidth = "420px";
    t.style.boxShadow = "0 10px 24px rgba(0,0,0,0.25)";
    t.style.fontSize = "14px";
    t.textContent = msg;

    if (type === "error") t.style.borderColor = "rgba(255, 99, 99, 0.35)";
    if (type === "success") t.style.borderColor = "rgba(99, 255, 168, 0.35)";

    wrap.appendChild(t);
    setTimeout(() => t.remove(), 3200);
  }

  function requireSb() {
    if (!window.sb) {
      root.innerHTML = `
        <div style="text-align:center;padding:24px;">
          <h3 style="margin:0 0 8px;">Backend not ready</h3>
          <p style="margin:0;opacity:.8;">window.sb is missing. Check <code>/js/supabaseClient.js</code> loads before <code>/admin/admin.js</code>.</p>
          <p style="margin:10px 0 0;opacity:.8;">Open DevTools → Console (Chrome: <b>Ctrl+Shift+I</b> then Console).</p>
        </div>
      `;
      return null;
    }
    return window.sb;
  }

  async function resolveTable(sb, key) {
    const candidates = TABLE_CANDIDATES[key] || [key];
    for (const name of candidates) {
      const { error } = await sb.from(name).select("*").limit(1);
      if (!error) return name;
    }
    return candidates[0]; // fallback (will show real error later)
  }

  function setLoading(title = "Loading…") {
    root.innerHTML = `
      <div style="text-align:center;padding:26px;">
        <h3 style="margin:0 0 8px;">${esc(title)}</h3>
        <p style="margin:0;opacity:.75;">Please wait.</p>
      </div>
    `;
  }

  // ---------- render: login ----------
  function renderLogin(prefillEmail = ADMIN_EMAIL) {
    root.innerHTML = `
      <div style="max-width:760px;margin:0 auto;">
        <div style="text-align:center;margin-bottom:16px;">
          <h3 style="margin:0;">Sign in</h3>
          <p style="margin:6px 0 0;opacity:.75;">Use your Supabase Auth admin credentials.</p>
        </div>

        <form id="admin-login-form" class="contact-form" method="post" action="javascript:void(0)">
          <label>
            Email
            <input type="email" name="email" placeholder="admin@email.com" required value="${esc(prefillEmail)}" />
          </label>

          <label>
            Password
            <input type="password" name="password" placeholder="Your password" required />
          </label>

          <button id="admin-login-btn" type="submit" class="btn btn-primary">Login</button>
          <p style="margin:10px 0 0;opacity:.7;font-size:.92rem;text-align:center;">
            Tip: In Supabase → Authentication → Users, ensure this user is <b>confirmed</b>.
          </p>
        </form>
      </div>
    `;

    const form = document.getElementById("admin-login-form");
    const btn = document.getElementById("admin-login-btn");

    form.addEventListener("submit", async () => {
      const sb = requireSb();
      if (!sb) return;

      const email = form.elements.email.value.trim();
      const password = form.elements.password.value;

      btn.disabled = true;
      btn.textContent = "Signing in…";

      try {
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if (error) {
          toast(error.message || "Login failed", "error");
          return;
        }
        if (!data?.session) {
          toast("No session returned. Check Supabase Auth settings.", "error");
          return;
        }
        await ensureAdminAndRender(sb);
      } catch (e) {
        toast(e?.message || "Login crashed", "error");
      } finally {
        btn.disabled = false;
        btn.textContent = "Login";
      }
    });
  }

  // ---------- render: app shell ----------
  function renderShell() {
    root.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap;margin-bottom:16px;">
        <button class="btn btn-secondary" data-tab="stats">Stats</button>
        <button class="btn btn-secondary" data-tab="experiments">Experiments</button>
        <button class="btn btn-secondary" data-tab="messages">Messages</button>
        <button class="btn btn-secondary" data-tab="newsletter">Newsletter</button>
        <button class="btn btn-secondary" id="admin-signout">Sign out</button>
      </div>

      <div id="tab-stats" class="admin-tab" style="display:none;"></div>
      <div id="tab-experiments" class="admin-tab" style="display:none;"></div>
      <div id="tab-messages" class="admin-tab" style="display:none;"></div>
      <div id="tab-newsletter" class="admin-tab" style="display:none;"></div>

      <div id="exp-modal" style="display:none;">
        <div id="exp-backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:9998;"></div>
        <div style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:9999;width:min(720px,calc(100% - 24px));">
          <div class="contact-form-card hover-float" style="margin:0;">
            <div style="text-align:center;margin-bottom:10px;">
              <h3 id="exp-modal-title" style="margin:0;">New Experiment</h3>
              <p style="margin:6px 0 0;opacity:.75;">Fill details and save.</p>
            </div>

            <form id="exp-form" class="contact-form" method="post" action="javascript:void(0)">
              <input type="hidden" name="id" />

              <label>
                Title
                <input type="text" name="title" placeholder="Pilot · XYZ mangrove reserve" required />
              </label>

              <label>
                Status
                <input type="text" name="status" placeholder="Upcoming / Planned / Design stage" />
              </label>

              <label>
                Description
                <textarea name="description" rows="4" placeholder="Short description"></textarea>
              </label>

              <label>
                Link URL (optional)
                <input type="url" name="link_url" placeholder="https://..." />
              </label>

              <label style="display:flex;gap:10px;align-items:center;font-size:.95rem;opacity:.9;text-transform:none;letter-spacing:0;">
                <input type="checkbox" name="is_published" />
                Published (show on live site)
              </label>

              <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:8px;">
                <button type="submit" class="btn btn-primary" id="exp-save-btn">Save</button>
                <button type="button" class="btn btn-secondary" id="exp-cancel-btn">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    `;

    // Tabs
    const tabBtns = root.querySelectorAll("[data-tab]");
    tabBtns.forEach((b) => {
      b.addEventListener("click", () => showTab(b.getAttribute("data-tab")));
    });

    // Sign out
    document.getElementById("admin-signout").addEventListener("click", async () => {
      const sb = requireSb();
      if (!sb) return;
      await sb.auth.signOut();
      toast("Signed out", "success");
      renderLogin();
    });

    // Modal close
    const modal = document.getElementById("exp-modal");
    const closeModal = () => (modal.style.display = "none");
    document.getElementById("exp-backdrop").addEventListener("click", closeModal);
    document.getElementById("exp-cancel-btn").addEventListener("click", closeModal);

    function showTab(name) {
      document.querySelectorAll(".admin-tab").forEach((t) => (t.style.display = "none"));
      const el = document.getElementById(`tab-${name}`);
      if (el) el.style.display = "block";
    }

    // Default
    showTab("stats");
  }

  // ---------- data: stats (ONE card only) ----------
  async function loadStats() {
    const el = document.getElementById("tab-stats");
    el.innerHTML = `
      <div class="section-header" style="text-align:center;margin-bottom:14px;">
        <h2 style="margin:0;">Stats</h2>
        <p style="margin:6px 0 0;">Unique visitors (lifetime)</p>
      </div>

      <div class="contact-form-card hover-float" style="max-width:520px;margin:0 auto;text-align:center;">
        <div style="opacity:.75;margin-bottom:6px;">Unique IP count</div>
        <div id="unique-count" style="font-size:2.2rem;font-weight:800;">—</div>
        <div style="opacity:.65;margin-top:8px;font-size:.92rem;">
          Counts each public IP once (NAT/VPN can group users).
        </div>
      </div>
    `;

    try {
      const r = await fetch(`/api/visitor-stats?t=${Date.now()}`, { cache: "no-store" });
      const j = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(j?.error || "visitor-stats failed");
      document.getElementById("unique-count").textContent =
        typeof j.unique_visitors === "number" ? String(j.unique_visitors) : "0";
    } catch (e) {
      document.getElementById("unique-count").textContent = "—";
      toast(e?.message || "Stats unavailable", "error");
    }
  }

  // ---------- data: experiments ----------
  async function loadExperiments(sb, experimentsTable) {
    const el = document.getElementById("tab-experiments");

    el.innerHTML = `
      <div class="section-header" style="text-align:center;margin-bottom:14px;">
        <h2 style="margin:0;">Experiments</h2>
        <p style="margin:6px 0 0;">Add / edit / delete and publish to the live site.</p>
      </div>

      <div style="display:flex;justify-content:center;margin-bottom:12px;">
        <button class="btn btn-primary" id="exp-new-btn">+ New</button>
      </div>

      <div class="contact-form-card hover-float" style="overflow:auto;">
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="text-align:left;opacity:.8;">
              <th style="padding:10px 8px;">Published</th>
              <th style="padding:10px 8px;">Status</th>
              <th style="padding:10px 8px;">Title</th>
              <th style="padding:10px 8px;">Actions</th>
            </tr>
          </thead>
          <tbody id="exp-rows"></tbody>
        </table>
      </div>
    `;

    document.getElementById("exp-new-btn").addEventListener("click", () => openExperimentModal(null));

    async function refresh() {
      const rows = document.getElementById("exp-rows");
      rows.innerHTML = `<tr><td colspan="4" style="padding:12px 8px;opacity:.75;">Loading…</td></tr>`;

      const { data, error } = await sb
        .from(experimentsTable)
        .select("*")
        .order("sort_order", { ascending: true, nullsFirst: true })
        .order("created_at", { ascending: false });

      if (error) {
        rows.innerHTML = `<tr><td colspan="4" style="padding:12px 8px;color:#ffb3b3;">${esc(
          error.message
        )}</td></tr>`;
        return;
      }

      if (!data?.length) {
        rows.innerHTML = `<tr><td colspan="4" style="padding:12px 8px;opacity:.75;">No experiments yet.</td></tr>`;
        return;
      }

      rows.innerHTML = data
        .map((x) => {
          const published = !!x.is_published;
          return `
            <tr style="border-top:1px solid rgba(255,255,255,0.08);">
              <td style="padding:10px 8px;">
                <input type="checkbox" data-action="toggle" data-id="${esc(x.id)}" ${published ? "checked" : ""}/>
              </td>
              <td style="padding:10px 8px;opacity:.85;">${esc(x.status || "")}</td>
              <td style="padding:10px 8px;">
                <div style="font-weight:700;">${esc(x.title || "")}</div>
                <div style="opacity:.7;font-size:.92rem;">${esc(x.description || "")}</div>
              </td>
              <td style="padding:10px 8px;">
                <button class="btn btn-secondary" data-action="edit" data-id="${esc(x.id)}">Edit</button>
                <button class="btn btn-secondary" data-action="del" data-id="${esc(x.id)}">Delete</button>
              </td>
            </tr>
          `;
        })
        .join("");

      rows.querySelectorAll("[data-action='toggle']").forEach((cb) => {
        cb.addEventListener("change", async () => {
          const id = cb.getAttribute("data-id");
          const { error: e2 } = await sb.from(experimentsTable).update({ is_published: cb.checked }).eq("id", id);
          if (e2) {
            toast(e2.message, "error");
            cb.checked = !cb.checked;
          } else {
            toast("Updated", "success");
          }
        });
      });

      rows.querySelectorAll("[data-action='edit']").forEach((b) => {
        b.addEventListener("click", async () => {
          const id = b.getAttribute("data-id");
          const { data: one, error: e2 } = await sb.from(experimentsTable).select("*").eq("id", id).maybeSingle();
          if (e2) return toast(e2.message, "error");
          openExperimentModal(one);
        });
      });

      rows.querySelectorAll("[data-action='del']").forEach((b) => {
        b.addEventListener("click", async () => {
          const id = b.getAttribute("data-id");
          if (!confirm("Delete this experiment?")) return;
          const { error: e2 } = await sb.from(experimentsTable).delete().eq("id", id);
          if (e2) toast(e2.message, "error");
          else {
            toast("Deleted", "success");
            refresh();
          }
        });
      });
    }

    function openExperimentModal(item) {
      const modal = document.getElementById("exp-modal");
      const form = document.getElementById("exp-form");
      const title = document.getElementById("exp-modal-title");
      const saveBtn = document.getElementById("exp-save-btn");

      form.reset();
      form.elements.id.value = item?.id || "";
      form.elements.title.value = item?.title || "";
      form.elements.status.value = item?.status || "";
      form.elements.description.value = item?.description || "";
      form.elements.link_url.value = item?.link_url || "";
      form.elements.is_published.checked = item ? !!item.is_published : true;

      title.textContent = item ? "Edit Experiment" : "New Experiment";
      saveBtn.textContent = item ? "Save changes" : "Create";

      modal.style.display = "block";

      form.onsubmit = async () => {
        const payload = {
          title: form.elements.title.value.trim(),
          status: form.elements.status.value.trim(),
          description: form.elements.description.value.trim(),
          link_url: form.elements.link_url.value.trim() || null,
          is_published: !!form.elements.is_published.checked,
        };

        if (!payload.title) return toast("Title required", "error");

        saveBtn.disabled = true;
        const old = saveBtn.textContent;
        saveBtn.textContent = "Saving…";

        try {
          if (item?.id) {
            const { error } = await sb.from(experimentsTable).update(payload).eq("id", item.id);
            if (error) throw error;
            toast("Saved", "success");
          } else {
            const { error } = await sb.from(experimentsTable).insert([payload]);
            if (error) throw error;
            toast("Created", "success");
          }
          modal.style.display = "none";
          refresh();
        } catch (e) {
          toast(e?.message || "Save failed", "error");
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = old;
        }
      };
    }

    refresh();
  }

  // ---------- data: messages ----------
  async function loadMessages(sb, messagesTable) {
    const el = document.getElementById("tab-messages");
    el.innerHTML = `
      <div class="section-header" style="text-align:center;margin-bottom:14px;">
        <h2 style="margin:0;">Messages</h2>
        <p style="margin:6px 0 0;">Open messages can be “Closed” and will move down.</p>
      </div>

      <div class="about-grid" style="grid-template-columns:1fr;gap:14px;">
        <div class="contact-form-card hover-float">
          <h3 style="margin:0 0 10px;text-align:center;">Open</h3>
          <div id="msg-open">Loading…</div>
        </div>

        <div class="contact-form-card hover-float">
          <h3 style="margin:0 0 10px;text-align:center;">Closed</h3>
          <div id="msg-closed">Loading…</div>
        </div>
      </div>
    `;

    async function refresh() {
      const { data, error } = await sb.from(messagesTable).select("*").order("created_at", { ascending: false });
      if (error) {
        document.getElementById("msg-open").innerHTML = `<div style="color:#ffb3b3;">${esc(error.message)}</div>`;
        document.getElementById("msg-closed").textContent = "";
        return;
      }

      const open = (data || []).filter((x) => (x.status || "open") === "open");
      const closed = (data || []).filter((x) => (x.status || "open") !== "open");

      document.getElementById("msg-open").innerHTML = renderList(open, true);
      document.getElementById("msg-closed").innerHTML = renderList(closed, false);

      document.querySelectorAll("[data-close-id]").forEach((b) => {
        b.addEventListener("click", async () => {
          const id = b.getAttribute("data-close-id");
          const { error: e2 } = await sb.from(messagesTable).update({ status: "closed" }).eq("id", id);
          if (e2) toast(e2.message, "error");
          else refresh();
        });
      });

      document.querySelectorAll("[data-reopen-id]").forEach((b) => {
        b.addEventListener("click", async () => {
          const id = b.getAttribute("data-reopen-id");
          const { error: e2 } = await sb.from(messagesTable).update({ status: "open" }).eq("id", id);
          if (e2) toast(e2.message, "error");
          else refresh();
        });
      });
    }

    function renderList(list, canClose) {
      if (!list.length) return `<div style="opacity:.7;">None.</div>`;

      return `
        <div style="display:flex;flex-direction:column;gap:10px;">
          ${list
            .map((x) => {
              const when = x.created_at ? new Date(x.created_at).toLocaleString() : "";
              return `
                <div style="border:1px solid rgba(255,255,255,0.10);border-radius:12px;padding:12px;">
                  <div style="display:flex;gap:10px;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;">
                    <div style="min-width:220px;">
                      <div style="font-weight:800;">${esc(x.name || "")}</div>
                      <div style="opacity:.8;font-size:.92rem;">${esc(x.email || "")}</div>
                      <div style="opacity:.65;font-size:.85rem;margin-top:2px;">${esc(when)}</div>
                    </div>
                    <div>
                      ${
                        canClose
                          ? `<button class="btn btn-secondary" data-close-id="${esc(x.id)}">Close</button>`
                          : `<button class="btn btn-secondary" data-reopen-id="${esc(x.id)}">Re-open</button>`
                      }
                    </div>
                  </div>
                  <div style="margin-top:10px;opacity:.9;white-space:pre-wrap;">${esc(x.message || "")}</div>
                </div>
              `;
            })
            .join("")}
        </div>
      `;
    }

    refresh();
  }

  // ---------- data: newsletter ----------
  async function loadNewsletter(sb, newsletterTable) {
    const el = document.getElementById("tab-newsletter");
    el.innerHTML = `
      <div class="section-header" style="text-align:center;margin-bottom:14px;">
        <h2 style="margin:0;">Newsletter</h2>
        <p style="margin:6px 0 0;">Subscribers collected from the contact form.</p>
      </div>

      <div class="contact-form-card hover-float" style="overflow:auto;">
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="text-align:left;opacity:.8;">
              <th style="padding:10px 8px;">Email</th>
              <th style="padding:10px 8px;">Created</th>
            </tr>
          </thead>
          <tbody id="nl-rows"></tbody>
        </table>
      </div>
    `;

    const rows = document.getElementById("nl-rows");
    const { data, error } = await sb.from(newsletterTable).select("*").order("created_at", { ascending: false });

    if (error) {
      rows.innerHTML = `<tr><td colspan="2" style="padding:12px 8px;color:#ffb3b3;">${esc(error.message)}</td></tr>`;
      return;
    }

    if (!data?.length) {
      rows.innerHTML = `<tr><td colspan="2" style="padding:12px 8px;opacity:.75;">No subscribers yet.</td></tr>`;
      return;
    }

    rows.innerHTML = data
      .map((x) => {
        const email = x.email || x.id || "";
        const when = x.created_at ? new Date(x.created_at).toLocaleString() : "";
        return `
          <tr style="border-top:1px solid rgba(255,255,255,0.08);">
            <td style="padding:10px 8px;">${esc(email)}</td>
            <td style="padding:10px 8px;opacity:.85;">${esc(when)}</td>
          </tr>
        `;
      })
      .join("");
  }

  // ---------- auth + boot ----------
  async function ensureAdminAndRender(sb) {
    setLoading("Preparing admin…");

    const { data: userData, error: userErr } = await sb.auth.getUser();
    if (userErr || !userData?.user) {
      toast(userErr?.message || "Not signed in", "error");
      return renderLogin();
    }

    const email = userData.user.email || "";
    if (email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
      await sb.auth.signOut();
      toast("This account is not allowed for admin.", "error");
      return renderLogin();
    }

    renderShell();

    // Resolve table names (safe if yours differ)
    const experimentsTable = await resolveTable(sb, "experiments");
    const messagesTable = await resolveTable(sb, "messages");
    const newsletterTable = await resolveTable(sb, "newsletter");

    // Load tabs (each handles errors internally)
    await loadStats();
    await loadExperiments(sb, experimentsTable);
    await loadMessages(sb, messagesTable);
    await loadNewsletter(sb, newsletterTable);

    // show stats tab by default
    document.getElementById("tab-stats").style.display = "block";
  }

  async function boot() {
    const sb = requireSb();
    if (!sb) return;

    try {
      const { data } = await sb.auth.getSession();
      if (data?.session) {
        await ensureAdminAndRender(sb);
      } else {
        renderLogin();
      }
    } catch (e) {
      toast(e?.message || "Admin boot failed", "error");
      renderLogin();
    }
  }

  document.addEventListener("DOMContentLoaded", boot);
})();
